# Spec: Run Request (v0.2.0)

## Overview

This spec defines the Run Request model — the single source of truth for what a run was configured to do. Currently Desktop is read-only; this spec prepares for write capability in a future phase while ensuring we properly display and rerun existing requests.

## Goals

1. **Display**: Show run request parameters clearly in Run Detail view
2. **Export**: Allow copying request as JSON
3. **Rerun**: Clone a request for editing and re-execution (Phase 1.4)

## Non-Goals (v0.2.0)

- Creating runs from scratch (Desktop remains read-only for execution)
- Validating requests against VS Code extension schemas (trust upstream)
- GPU device selection UI (Phase 4)

---

## Run Request Schema

### Location

```
<workspace>/
  <run-id>/
    request.json      # The Run Request
    result.json       # Execution result
    artifacts/        # Output artifacts
```

### Minimal Schema (v1)

```json
{
  "$schema": "https://runforge.dev/schemas/request.v1.json",
  "version": 1,
  "preset": "balanced",
  "dataset": {
    "path": "data/iris.csv",
    "label_column": "species"
  },
  "model": {
    "family": "logistic_regression",
    "hyperparameters": {}
  },
  "device": {
    "type": "cpu",
    "gpu_reason": null
  },
  "created_at": "2026-02-01T12:00:00Z",
  "created_by": "runforge-vscode@0.3.6"
}
```

### Field Definitions

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `version` | integer | Yes | Schema version (currently 1) |
| `preset` | string | Yes | Preset name: `fast`, `balanced`, `thorough`, `custom` |
| `dataset.path` | string | Yes | Path to dataset file (relative to workspace) |
| `dataset.label_column` | string | Yes | Target column name |
| `model.family` | string | Yes | Model type: `logistic_regression`, `random_forest`, `linear_svc`, etc. |
| `model.hyperparameters` | object | No | Override hyperparameters (empty = use preset defaults) |
| `device.type` | string | Yes | `cpu` or `gpu` |
| `device.gpu_reason` | string | No | If GPU blocked, reason why |
| `created_at` | string | Yes | ISO 8601 timestamp |
| `created_by` | string | Yes | Tool + version that created the request |

---

## UI Behavior

### Run Detail View

Display request fields in a structured form:

```
┌─────────────────────────────────────────────┐
│ Request                                      │
├─────────────────────────────────────────────┤
│ Preset:     balanced                         │
│ Dataset:    data/iris.csv (species)          │
│ Model:      logistic_regression              │
│ Device:     CPU                              │
│ Created:    Feb 1, 2026 12:00 PM             │
│                                              │
│ [View Raw JSON]  [Copy JSON]  [Rerun]        │
└─────────────────────────────────────────────┘
```

### Raw JSON View

Modal or panel showing the full `request.json` with:
- Syntax highlighting
- Copy button
- Read-only (no editing in v0.2.0)

### Rerun Flow (v0.2.1+)

1. User clicks "Rerun" on a completed run
2. Desktop clones `request.json` into memory
3. User can edit fields in a form
4. User clicks "Execute"
5. Desktop writes new request to temp location
6. Desktop invokes VS Code extension (or CLI) to execute
7. New run appears in list with `rerun_from: <original-run-id>`

---

## Acceptance Criteria

### Display (v0.2.0)

- [ ] Run Detail shows all request fields from `request.json`
- [ ] Missing/malformed `request.json` shows graceful error state
- [ ] "View Raw JSON" opens modal with formatted JSON
- [ ] "Copy JSON" copies request to clipboard with success toast

### Validation (v0.2.0)

- [ ] Request with missing required fields shows field-level errors
- [ ] Request with unknown fields is displayed (forward compatibility)
- [ ] Version mismatch shows warning but still displays

### Rerun (v0.2.1 - separate spec)

- [ ] "Rerun" button appears on completed/failed runs
- [ ] Clone creates new request with `rerun_from` field
- [ ] User can edit preset, dataset, model before execution
- [ ] Rerun produces new run ID (not overwrite)

---

## Test Cases

### Unit Tests

1. **Parse valid request** - Load well-formed `request.json`, verify all fields accessible
2. **Parse minimal request** - Load request with only required fields
3. **Handle missing file** - Return null/error state for missing `request.json`
4. **Handle malformed JSON** - Return error state for invalid JSON
5. **Handle unknown fields** - Ignore unknown fields, parse known fields
6. **Handle version mismatch** - Parse with warning for version > 1

### Integration Tests

7. **Display request in UI** - Load run, verify request fields render correctly
8. **Copy to clipboard** - Click copy, verify clipboard contains valid JSON
9. **View raw JSON** - Click view, verify modal shows formatted JSON
10. **Navigate runs with requests** - Switch between runs, verify request updates

---

## Migration

Existing runs without `request.json` (pre-v0.2.0) will show:
- "Request not available" in the Request section
- Rerun button disabled
- No breaking changes to existing functionality

---

## Implementation Notes

### Model

```csharp
public record RunRequest
{
    public int Version { get; init; } = 1;
    public required string Preset { get; init; }
    public required DatasetConfig Dataset { get; init; }
    public required ModelConfig Model { get; init; }
    public required DeviceConfig Device { get; init; }
    public required DateTimeOffset CreatedAt { get; init; }
    public required string CreatedBy { get; init; }
    public string? RerunFrom { get; init; }
}

public record DatasetConfig
{
    public required string Path { get; init; }
    public required string LabelColumn { get; init; }
}

public record ModelConfig
{
    public required string Family { get; init; }
    public Dictionary<string, object>? Hyperparameters { get; init; }
}

public record DeviceConfig
{
    public required string Type { get; init; }
    public string? GpuReason { get; init; }
}
```

### Service

```csharp
public interface IRunRequestService
{
    Task<RunRequest?> LoadAsync(string runDir);
    Task<string> SerializeAsync(RunRequest request);
    ValidationResult Validate(RunRequest request);
}
```

---

## Open Questions

1. **Hyperparameter editing UI** - Form fields vs JSON editor for `hyperparameters`?
   - Recommendation: JSON editor for v0.2.x, typed form in v0.3+

2. **Rerun execution** - Shell out to CLI or communicate with VS Code extension?
   - Recommendation: CLI first (simpler), extension integration later

---

*Status: Draft*
*Author: Claude*
*Created: 2026-02-01*
