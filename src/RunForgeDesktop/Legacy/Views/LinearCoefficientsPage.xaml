<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:RunForgeDesktop.ViewModels"
             x:Class="RunForgeDesktop.Views.LinearCoefficientsPage"
             x:DataType="vm:LinearCoefficientsViewModel"
             Title="Linear Coefficients">

    <Grid RowDefinitions="Auto,*,Auto" Padding="16">

        <!-- Header -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,16">
            <VerticalStackLayout Grid.Column="0" Spacing="4">
                <Label Text="Linear Coefficients"
                       FontSize="24"
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#E0E0E0}" />
                <Label Text="{Binding RunName}"
                       FontSize="14"
                       TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                <HorizontalStackLayout Spacing="16"
                                       IsVisible="{Binding Artifact, Converter={StaticResource ObjectToBoolConverter}}">
                    <Label Text="{Binding Artifact.ModelFamily, StringFormat='Model: {0}'}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#888888, Dark=#777777}" />
                    <Label Text="{Binding Artifact.Standardized, StringFormat='Standardized: {0}'}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#888888, Dark=#777777}" />
                </HorizontalStackLayout>
            </VerticalStackLayout>

            <HorizontalStackLayout Grid.Column="1" Spacing="8" VerticalOptions="Center">
                <Button Text="Export CSV"
                        Command="{Binding ExportToCsvCommand}"
                        BackgroundColor="{AppThemeBinding Light=#4CAF50, Dark=#388E3C}"
                        TextColor="White"
                        CornerRadius="4"
                        Padding="16,8"
                        ToolTipProperties.Text="Export linear coefficients data to CSV file" />
                <Button Text="Open JSON"
                        Command="{Binding OpenRawJsonCommand}"
                        BackgroundColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                        TextColor="White"
                        CornerRadius="4"
                        Padding="16,8"
                        ToolTipProperties.Text="Open raw JSON artifact in default viewer" />
            </HorizontalStackLayout>
        </Grid>

        <!-- Status message bar -->
        <Frame Grid.Row="0"
               IsVisible="{Binding StatusMessage, Converter={StaticResource StringToBoolConverter}}"
               BackgroundColor="{AppThemeBinding Light=#E8F5E9, Dark=#1B5E20}"
               BorderColor="{AppThemeBinding Light=#4CAF50, Dark=#81C784}"
               CornerRadius="4"
               Padding="8"
               Margin="0,80,0,0"
               VerticalOptions="Start">
            <Label Text="{Binding StatusMessage}"
                   FontSize="12"
                   TextColor="{AppThemeBinding Light=#2E7D32, Dark=#A5D6A7}"
                   HorizontalOptions="Center" />
        </Frame>

        <!-- Content -->
        <ScrollView Grid.Row="1">
            <Grid>
                <!-- Loading indicator -->
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                   IsVisible="{Binding IsLoading}"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"
                                   Color="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}" />

                <!-- Error message -->
                <Frame IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}"
                       BackgroundColor="{AppThemeBinding Light=#FFEBEE, Dark=#3E2723}"
                       BorderColor="{AppThemeBinding Light=#EF5350, Dark=#D32F2F}"
                       CornerRadius="8"
                       Padding="16"
                       Margin="0,0,0,16">
                    <VerticalStackLayout Spacing="8">
                        <Label Text="Error loading linear coefficients"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#C62828, Dark=#EF5350}" />
                        <Label Text="{Binding ErrorMessage}"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                    </VerticalStackLayout>
                </Frame>

                <!-- Coefficients content -->
                <VerticalStackLayout Spacing="16"
                                     IsVisible="{Binding Artifact, Converter={StaticResource ObjectToBoolConverter}}">

                    <!-- Class selector and intercept -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                           BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                           CornerRadius="8"
                           Padding="16">
                        <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,*" RowSpacing="12" ColumnSpacing="24">
                            <VerticalStackLayout Grid.Row="0" Grid.Column="0" Spacing="4">
                                <Label Text="Class"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Picker ItemsSource="{Binding ClassLabels}"
                                        SelectedItem="{Binding SelectedClass}"
                                        BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#333333}"
                                        TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}" />
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Row="0" Grid.Column="1" Spacing="4">
                                <Label Text="Intercept"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Text="{Binding SelectedIntercept, StringFormat='{0:F6}'}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}" />
                            </VerticalStackLayout>

                            <!-- Standardization warning -->
                            <Frame Grid.Row="1" Grid.ColumnSpan="2"
                                   BackgroundColor="{AppThemeBinding Light=#FFF8E1, Dark=#3E2723}"
                                   BorderColor="{AppThemeBinding Light=#FFE082, Dark=#FF8F00}"
                                   CornerRadius="4"
                                   Padding="8"
                                   IsVisible="{Binding Artifact.Standardized}">
                                <Label Text="Note: Coefficients are in standardized space. Raw coefficient values require unstandardization."
                                       FontSize="11"
                                       TextColor="{AppThemeBinding Light=#F57C00, Dark=#FFB74D}" />
                            </Frame>
                        </Grid>
                    </Frame>

                    <!-- Coefficients list -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                           BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                           CornerRadius="8"
                           Padding="16">
                        <VerticalStackLayout Spacing="8">
                            <!-- Table header -->
                            <Grid ColumnDefinitions="50,*,120,Auto"
                                  Padding="12,8"
                                  BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#333333}">
                                <Label Grid.Column="0" Text="Rank" FontAttributes="Bold" FontSize="12" />
                                <Label Grid.Column="1" Text="Feature" FontAttributes="Bold" FontSize="12" />
                                <Label Grid.Column="2" Text="Coefficient" FontAttributes="Bold" FontSize="12" HorizontalTextAlignment="End" />
                                <Label Grid.Column="3" Text="" WidthRequest="150" />
                            </Grid>

                            <!-- Coefficients list -->
                            <CollectionView ItemsSource="{Binding Coefficients}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="vm:CoefficientItem">
                                        <Grid ColumnDefinitions="50,*,120,150"
                                              Padding="12,8"
                                              BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}">
                                            <!-- Rank -->
                                            <Label Grid.Column="0"
                                                   Text="{Binding Rank}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light=#888888, Dark=#777777}"
                                                   VerticalOptions="Center" />

                                            <!-- Feature name -->
                                            <Label Grid.Column="1"
                                                   Text="{Binding FeatureName}"
                                                   FontSize="13"
                                                   TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}"
                                                   VerticalOptions="Center"
                                                   LineBreakMode="TailTruncation" />

                                            <!-- Coefficient value -->
                                            <Label Grid.Column="2"
                                                   Text="{Binding CoefficientDisplay}"
                                                   FontSize="12"
                                                   FontAttributes="Bold"
                                                   TextColor="{Binding IsPositive, Converter={StaticResource PositiveToColorConverter}}"
                                                   HorizontalTextAlignment="End"
                                                   VerticalOptions="Center" />

                                            <!-- Visual bar -->
                                            <Grid Grid.Column="3" Padding="8,0,0,0" VerticalOptions="Center">
                                                <BoxView BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                                                         HeightRequest="16"
                                                         CornerRadius="2"
                                                         HorizontalOptions="Fill" />
                                                <BoxView BackgroundColor="{Binding IsPositive, Converter={StaticResource PositiveToColorConverter}}"
                                                         HeightRequest="16"
                                                         CornerRadius="2"
                                                         HorizontalOptions="Start"
                                                         WidthRequest="{Binding BarWidthPercent, Converter={StaticResource PercentToWidthConverter}}" />
                                            </Grid>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Frame>
                </VerticalStackLayout>
            </Grid>
        </ScrollView>

        <!-- Footer with show more buttons -->
        <HorizontalStackLayout Grid.Row="2"
                               HorizontalOptions="Center"
                               Spacing="16"
                               Margin="0,16,0,0"
                               IsVisible="{Binding Artifact, Converter={StaticResource ObjectToBoolConverter}}">
            <Button Text="Show More"
                    Command="{Binding ShowMoreCommand}"
                    BackgroundColor="Transparent"
                    TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                    BorderColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                    BorderWidth="1"
                    CornerRadius="4"
                    Padding="16,8" />
            <Button Text="Show All"
                    Command="{Binding ShowAllCommand}"
                    BackgroundColor="Transparent"
                    TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                    BorderColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                    BorderWidth="1"
                    CornerRadius="4"
                    Padding="16,8" />
        </HorizontalStackLayout>

    </Grid>

</ContentPage>
