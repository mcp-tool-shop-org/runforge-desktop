<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:RunForgeDesktop.ViewModels"
             xmlns:models="clr-namespace:RunForgeDesktop.Core.Models;assembly=RunForgeDesktop.Core"
             x:Class="RunForgeDesktop.Views.RunDetailPage"
             x:DataType="vm:RunDetailViewModel"
             Title="{Binding RunName, StringFormat='Run: {0}'}">

    <Grid RowDefinitions="Auto,*,Auto" Padding="16">

        <!-- Header -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,16">
            <VerticalStackLayout Grid.Column="0" Spacing="4">
                <Label Text="{Binding RunName}"
                       FontSize="24"
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#E0E0E0}" />
                <Label Text="{Binding RunId}"
                       FontSize="14"
                       TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
            </VerticalStackLayout>

            <HorizontalStackLayout Grid.Column="1" Spacing="8" VerticalOptions="Center">
                <Button Text="Open Folder"
                        Command="{Binding OpenRunFolderCommand}"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                        FontSize="12"
                        Padding="8,4"
                        ToolTipProperties.Text="Open run folder in file explorer" />
                <Button Text="Compare with Parent"
                        Command="{Binding NavigateToComparePageCommand}"
                        IsVisible="{Binding HasParent}"
                        BackgroundColor="{AppThemeBinding Light=#FF9800, Dark=#E65100}"
                        TextColor="White"
                        CornerRadius="4"
                        Padding="16,8"
                        ToolTipProperties.Text="Compare this run with its parent (metrics, config, artifacts)" />
                <Button Text="Interpretability"
                        Command="{Binding NavigateToInterpretabilityCommand}"
                        BackgroundColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                        TextColor="White"
                        CornerRadius="4"
                        Padding="16,8"
                        ToolTipProperties.Text="View model interpretability artifacts" />
            </HorizontalStackLayout>
        </Grid>

        <!-- Content -->
        <ScrollView Grid.Row="1">
            <Grid>
                <!-- Loading indicator -->
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                   IsVisible="{Binding IsLoading}"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"
                                   Color="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}" />

                <!-- Error message -->
                <Frame IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}"
                       BackgroundColor="{AppThemeBinding Light=#FFEBEE, Dark=#3E2723}"
                       BorderColor="{AppThemeBinding Light=#EF5350, Dark=#D32F2F}"
                       CornerRadius="8"
                       Padding="16"
                       Margin="0,0,0,16">
                    <VerticalStackLayout Spacing="8">
                        <Label Text="Error loading run details"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#C62828, Dark=#EF5350}" />
                        <Label Text="{Binding ErrorMessage}"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                        <Button Text="Open Run Folder"
                                Command="{Binding OpenRunFolderCommand}"
                                BackgroundColor="{AppThemeBinding Light=#EF5350, Dark=#D32F2F}"
                                TextColor="White"
                                CornerRadius="4"
                                Padding="12,6"
                                HorizontalOptions="Start"
                                Margin="0,8,0,0" />
                    </VerticalStackLayout>
                </Frame>

                <!-- Run details -->
                <VerticalStackLayout Spacing="16"
                                     IsVisible="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}">

                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <!-- LIVE SECTION: Heartbeat + Timeline + Log Tail -->
                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                           BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                           CornerRadius="8"
                           Padding="16"
                           IsVisible="{Binding LogSnapshot, Converter={StaticResource ObjectToBoolConverter}}">
                        <VerticalStackLayout Spacing="12">
                            <!-- Header with heartbeat status -->
                            <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                                <Label Grid.Column="0"
                                       Text="Live Status"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}"
                                       VerticalOptions="Center" />

                                <!-- Heartbeat pill -->
                                <Frame Grid.Column="2"
                                       BackgroundColor="{Binding LogSnapshot.Status, Converter={StaticResource LogStatusToColorConverter}}"
                                       CornerRadius="12"
                                       Padding="12,4"
                                       HasShadow="False"
                                       Margin="8,0">
                                    <HorizontalStackLayout Spacing="6">
                                        <Label Text="{Binding LogSnapshot.StatusIndicator}"
                                               TextColor="White"
                                               FontSize="12"
                                               VerticalOptions="Center" />
                                        <Label Text="{Binding LogSnapshot.StatusMessage}"
                                               TextColor="White"
                                               FontSize="12"
                                               VerticalOptions="Center" />
                                    </HorizontalStackLayout>
                                </Frame>

                                <!-- Signal strip (lines added indicator) -->
                                <HorizontalStackLayout Grid.Column="3"
                                                       Spacing="2"
                                                       IsVisible="{Binding IsMonitoringActive}"
                                                       VerticalOptions="Center">
                                    <BoxView WidthRequest="4"
                                             HeightRequest="12"
                                             CornerRadius="2"
                                             Color="{Binding LinesAddedThisTick, Converter={StaticResource ObjectToBoolConverter}, ConverterParameter=1}"
                                             BackgroundColor="{AppThemeBinding Light=#4CAF50, Dark=#81C784}"
                                             Opacity="{Binding LinesAddedThisTick, Converter={StaticResource ObjectToBoolConverter}}" />
                                    <Label Text="{Binding LinesAddedThisTick, StringFormat='+{0}'}"
                                           FontSize="10"
                                           TextColor="{AppThemeBinding Light=#4CAF50, Dark=#81C784}"
                                           IsVisible="{Binding LinesAddedThisTick}"
                                           VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Grid>

                            <!-- Log file size info row -->
                            <Grid ColumnDefinitions="Auto,Auto,*,Auto" ColumnSpacing="12">
                                <Label Grid.Column="0"
                                       Text="{Binding LogFileSizeDisplay, StringFormat='logs.txt: {0}'}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light=#666666, Dark=#999999}"
                                       VerticalOptions="Center" />
                                <Label Grid.Column="1"
                                       Text="{Binding LogLineCountEstimate}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light=#888888, Dark=#777777}"
                                       VerticalOptions="Center" />
                                <Button Grid.Column="3"
                                        Text="Copy Path"
                                        Command="{Binding CopyLogFilePathCommand}"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light=#666666, Dark=#999999}"
                                        FontSize="11"
                                        Padding="6,2"
                                        ToolTipProperties.Text="Copy full logs.txt path to clipboard" />
                            </Grid>

                            <!-- Log size warning banner (info/warning/danger) -->
                            <Frame IsVisible="{Binding ShowLogSizeWarning}"
                                   BackgroundColor="{AppThemeBinding Light=#FFF8E1, Dark=#3E2700}"
                                   BorderColor="{AppThemeBinding Light=#FFB74D, Dark=#FF8F00}"
                                   CornerRadius="4"
                                   Padding="10,8"
                                   HasShadow="False">
                                <Grid ColumnDefinitions="Auto,*,Auto">
                                    <Label Grid.Column="0"
                                           Text="⚠"
                                           FontSize="14"
                                           TextColor="{AppThemeBinding Light=#E65100, Dark=#FFB74D}"
                                           VerticalOptions="Center"
                                           Margin="0,0,8,0" />
                                    <Label Grid.Column="1"
                                           Text="{Binding LogSizeWarningMessage}"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light=#E65100, Dark=#FFB74D}"
                                           VerticalOptions="Center" />
                                    <Button Grid.Column="2"
                                            Text="✕"
                                            Command="{Binding DismissLogSizeWarningCommand}"
                                            BackgroundColor="Transparent"
                                            TextColor="{AppThemeBinding Light=#E65100, Dark=#FFB74D}"
                                            FontSize="12"
                                            Padding="4"
                                            WidthRequest="24" />
                                </Grid>
                            </Frame>

                            <!-- Epoch progress (if detected) -->
                            <Frame IsVisible="{Binding EpochProgressDisplay, Converter={StaticResource StringToBoolConverter}}"
                                   BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#1A237E}"
                                   BorderColor="Transparent"
                                   CornerRadius="4"
                                   Padding="8,4"
                                   HasShadow="False">
                                <Label Text="{Binding EpochProgressDisplay}"
                                       FontSize="13"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#1565C0, Dark=#90CAF9}" />
                            </Frame>

                            <!-- File reset notification -->
                            <Frame IsVisible="{Binding WasFileReset}"
                                   BackgroundColor="{AppThemeBinding Light=#FFF8E1, Dark=#3E2723}"
                                   BorderColor="{AppThemeBinding Light=#FFB74D, Dark=#FF8F00}"
                                   CornerRadius="4"
                                   Padding="8,4"
                                   HasShadow="False">
                                <Label Text="{Binding FileResetReason}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light=#E65100, Dark=#FFB74D}" />
                            </Frame>

                            <!-- Possible stall warning -->
                            <Frame IsVisible="{Binding ShowStuckWarning}"
                                   BackgroundColor="{AppThemeBinding Light=#FFF3E0, Dark=#4A2C00}"
                                   BorderColor="{AppThemeBinding Light=#FF9800, Dark=#FF9800}"
                                   CornerRadius="8"
                                   Padding="12"
                                   HasShadow="False">
                                <VerticalStackLayout Spacing="8">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <Label Grid.Column="0"
                                               Text="Possible Stall Detected"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{AppThemeBinding Light=#E65100, Dark=#FFB74D}" />
                                        <Button Grid.Column="1"
                                                Text="✕"
                                                Command="{Binding DismissStuckWarningCommand}"
                                                BackgroundColor="Transparent"
                                                TextColor="{AppThemeBinding Light=#E65100, Dark=#FFB74D}"
                                                FontSize="14"
                                                Padding="4"
                                                WidthRequest="28" />
                                    </Grid>
                                    <Label Text="{Binding LogSnapshot.StatusMessage, StringFormat='No log activity: {0}'}"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                    <Label Text="{Binding LastMilestoneName, StringFormat='Last milestone: {0} at '}"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light=#666666, Dark=#999999}"
                                           IsVisible="{Binding LastMilestoneName, Converter={StaticResource StringToBoolConverter}}" />
                                    <HorizontalStackLayout Spacing="8" Margin="0,4,0,0">
                                        <Button Text="Open Logs"
                                                Command="{Binding OpenRawFileCommand}"
                                                CommandParameter="logs.txt"
                                                BackgroundColor="{AppThemeBinding Light=#FF9800, Dark=#E65100}"
                                                TextColor="White"
                                                CornerRadius="4"
                                                Padding="12,6"
                                                FontSize="12" />
                                        <Button Text="Open Folder"
                                                Command="{Binding OpenRunFolderCommand}"
                                                BackgroundColor="Transparent"
                                                TextColor="{AppThemeBinding Light=#E65100, Dark=#FFB74D}"
                                                CornerRadius="4"
                                                Padding="12,6"
                                                FontSize="12" />
                                        <Button Text="Copy Diagnostics"
                                                Command="{Binding CopyDiagnosticsSummaryCommand}"
                                                BackgroundColor="Transparent"
                                                TextColor="{AppThemeBinding Light=#E65100, Dark=#FFB74D}"
                                                CornerRadius="4"
                                                Padding="12,6"
                                                FontSize="12" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Frame>

                            <!-- Timeline milestones -->
                            <Grid IsVisible="{Binding TimelineState, Converter={StaticResource ObjectToBoolConverter}}">
                                <HorizontalStackLayout Spacing="8"
                                                       HorizontalOptions="Start"
                                                       BindableLayout.ItemsSource="{Binding TimelineState.Milestones}">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="models:RunMilestone">
                                            <Frame Padding="8,4"
                                                   CornerRadius="4"
                                                   HasShadow="False"
                                                   BackgroundColor="{Binding IsReached, Converter={StaticResource MilestoneToColorConverter}}"
                                                   BorderColor="{Binding IsActive, Converter={StaticResource MilestoneToColorConverter}}">
                                                <Label Text="{Binding Name}"
                                                       FontSize="11"
                                                       FontAttributes="{Binding IsActive, Converter={StaticResource MilestoneToFontConverter}}"
                                                       TextColor="{Binding IsReached, Converter={StaticResource ObjectToBoolConverter}, ConverterParameter=White, FallbackValue=#666666}" />
                                            </Frame>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </HorizontalStackLayout>
                            </Grid>

                            <!-- Log tail toggle -->
                            <Grid ColumnDefinitions="*,Auto,Auto,Auto">
                                <Button Grid.Column="0"
                                        Text="{Binding ShowLogTail, Converter={StaticResource InverseBoolConverter}, ConverterParameter='Show Logs,Hide Logs'}"
                                        Command="{Binding ToggleLogTailCommand}"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                                        FontSize="12"
                                        Padding="0"
                                        HorizontalOptions="Start" />

                                <Button Grid.Column="1"
                                        Text="{Binding IsLogTailPaused, Converter={StaticResource InverseBoolConverter}, ConverterParameter='Pause,Resume'}"
                                        Command="{Binding ToggleLogTailPauseCommand}"
                                        IsVisible="{Binding ShowLogTail}"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light=#666666, Dark=#999999}"
                                        FontSize="12"
                                        Padding="8,4" />

                                <Button Grid.Column="2"
                                        Text="Copy"
                                        Command="{Binding CopyVisibleLogsCommand}"
                                        IsVisible="{Binding ShowLogTail}"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light=#666666, Dark=#999999}"
                                        FontSize="12"
                                        Padding="8,4" />

                                <Button Grid.Column="3"
                                        Text="Open logs.txt"
                                        Command="{Binding OpenRawFileCommand}"
                                        CommandParameter="logs.txt"
                                        IsVisible="{Binding ShowLogTail}"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light=#666666, Dark=#999999}"
                                        FontSize="12"
                                        Padding="8,4" />
                            </Grid>

                            <!-- Log tail content -->
                            <Frame IsVisible="{Binding ShowLogTail}"
                                   BackgroundColor="{AppThemeBinding Light=#1E1E1E, Dark=#0D0D0D}"
                                   BorderColor="{AppThemeBinding Light=#333333, Dark=#1A1A1A}"
                                   CornerRadius="4"
                                   Padding="0"
                                   HasShadow="False"
                                   HeightRequest="250">
                                <Grid RowDefinitions="Auto,*">
                                    <!-- Search bar -->
                                    <Grid Grid.Row="0"
                                          ColumnDefinitions="*,Auto"
                                          BackgroundColor="{AppThemeBinding Light=#2D2D2D, Dark=#1A1A1A}"
                                          Padding="8,4">
                                        <Entry Grid.Column="0"
                                               Placeholder="Search logs..."
                                               Text="{Binding LogSearchQuery}"
                                               BackgroundColor="Transparent"
                                               TextColor="{AppThemeBinding Light=#CCCCCC, Dark=#AAAAAA}"
                                               PlaceholderColor="{AppThemeBinding Light=#666666, Dark=#555555}"
                                               FontSize="12" />
                                        <Button Grid.Column="1"
                                                Text="✕"
                                                Command="{Binding ClearLogSearchCommand}"
                                                IsVisible="{Binding LogSearchQuery, Converter={StaticResource StringToBoolConverter}}"
                                                BackgroundColor="Transparent"
                                                TextColor="{AppThemeBinding Light=#999999, Dark=#666666}"
                                                FontSize="12"
                                                Padding="8,2"
                                                WidthRequest="30" />
                                    </Grid>

                                    <!-- Log lines -->
                                    <CollectionView Grid.Row="1"
                                                    ItemsSource="{Binding FilteredLogLines}"
                                                    SelectionMode="None">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="x:String">
                                                <Label Text="{Binding}"
                                                       FontFamily="Consolas, Courier New, monospace"
                                                       FontSize="11"
                                                       TextColor="{AppThemeBinding Light=#CCCCCC, Dark=#AAAAAA}"
                                                       Padding="8,1"
                                                       LineBreakMode="NoWrap" />
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </Grid>
                            </Frame>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <!-- REQUEST SECTION -->
                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                           BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                           CornerRadius="8"
                           Padding="16"
                           IsVisible="{Binding Request, Converter={StaticResource ObjectToBoolConverter}}">
                        <VerticalStackLayout Spacing="12">
                            <!-- Header with action buttons -->
                            <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto,Auto">
                                <Label Grid.Column="0"
                                       Text="Run Request"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}" />
                                <Button Grid.Column="1"
                                        Text="Edit"
                                        Command="{Binding NavigateToEditorCommand}"
                                        BackgroundColor="{AppThemeBinding Light=#4CAF50, Dark=#388E3C}"
                                        TextColor="White"
                                        CornerRadius="4"
                                        FontSize="12"
                                        Padding="12,6"
                                        ToolTipProperties.Text="Edit request configuration (for completed runs, creates a rerun first)"
                                        IsVisible="{Binding CanEdit}" />
                                <Button Grid.Column="2"
                                        Text="View JSON"
                                        Command="{Binding ViewRequestJsonCommand}"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                                        FontSize="12"
                                        Padding="8,4"
                                        ToolTipProperties.Text="View formatted JSON" />
                                <Button Grid.Column="3"
                                        Text="Copy"
                                        Command="{Binding CopyRequestJsonCommand}"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                                        FontSize="12"
                                        Padding="8,4"
                                        ToolTipProperties.Text="Copy JSON to clipboard" />
                                <Button Grid.Column="4"
                                        Text="Open File"
                                        Command="{Binding OpenRawFileCommand}"
                                        CommandParameter="request.json"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                                        FontSize="12"
                                        Padding="8,4"
                                        ToolTipProperties.Text="Open in default editor" />
                            </Grid>

                            <!-- Core fields -->
                            <Grid ColumnDefinitions="140,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto" RowSpacing="8">
                                <Label Grid.Row="0" Grid.Column="0" Text="Preset:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Grid.Row="0" Grid.Column="1" Text="{Binding Request.Preset}" FontAttributes="Bold" />

                                <Label Grid.Row="1" Grid.Column="0" Text="Model:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Grid.Row="1" Grid.Column="1" Text="{Binding Request.Model.Family}" />

                                <Label Grid.Row="2" Grid.Column="0" Text="Dataset:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Grid.Row="2" Grid.Column="1" Text="{Binding Request.Dataset.Path}" />

                                <Label Grid.Row="3" Grid.Column="0" Text="Label Column:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Grid.Row="3" Grid.Column="1" Text="{Binding Request.Dataset.LabelColumn}" />

                                <Label Grid.Row="4" Grid.Column="0" Text="Device:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Grid.Row="4" Grid.Column="1" Text="{Binding Request.Device.Type}" />

                                <Label Grid.Row="5" Grid.Column="0" Text="Created:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Grid.Row="5" Grid.Column="1" Text="{Binding FormattedCreatedAt}" />

                                <Label Grid.Row="6" Grid.Column="0" Text="Created By:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Grid.Row="6" Grid.Column="1" Text="{Binding Request.CreatedBy}" />
                            </Grid>

                            <!-- Optional fields (only shown if present) -->
                            <VerticalStackLayout Spacing="8" IsVisible="{Binding HasRequestExtras}">
                                <BoxView HeightRequest="1" Color="{AppThemeBinding Light=#E0E0E0, Dark=#404040}" Margin="0,4" />

                                <!-- User-provided name -->
                                <Grid ColumnDefinitions="140,*" IsVisible="{Binding Request.Name, Converter={StaticResource StringToBoolConverter}}">
                                    <Label Grid.Column="0" Text="Name:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                    <Label Grid.Column="1" Text="{Binding Request.Name}" FontAttributes="Italic" />
                                </Grid>

                                <!-- Rerun source with diff button -->
                                <Grid ColumnDefinitions="140,*,Auto" IsVisible="{Binding Request.RerunFrom, Converter={StaticResource StringToBoolConverter}}">
                                    <Label Grid.Column="0" Text="Rerun From:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                    <Label Grid.Column="1" Text="{Binding Request.RerunFrom}" TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}" />
                                    <Button Grid.Column="2"
                                            Text="View Changes"
                                            Command="{Binding ViewDiffFromParentCommand}"
                                            BackgroundColor="Transparent"
                                            TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                                            FontSize="11"
                                            Padding="8,2"
                                            ToolTipProperties.Text="Compare changes from parent run" />
                                </Grid>

                                <!-- Tags -->
                                <Grid ColumnDefinitions="140,*" IsVisible="{Binding TagsDisplay, Converter={StaticResource StringToBoolConverter}}">
                                    <Label Grid.Column="0" Text="Tags:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                    <Label Grid.Column="1" Text="{Binding TagsDisplay}" />
                                </Grid>

                                <!-- GPU Reason -->
                                <Grid ColumnDefinitions="140,*" IsVisible="{Binding Request.Device.GpuReason, Converter={StaticResource StringToBoolConverter}}">
                                    <Label Grid.Column="0" Text="GPU Reason:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                    <Label Grid.Column="1" Text="{Binding Request.Device.GpuReason}" TextColor="{AppThemeBinding Light=#E65100, Dark=#FFB74D}" />
                                </Grid>

                                <!-- Notes -->
                                <VerticalStackLayout Spacing="4" IsVisible="{Binding Request.Notes, Converter={StaticResource StringToBoolConverter}}">
                                    <Label Text="Notes:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                    <Frame BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#1A1A1A}"
                                           BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#333333}"
                                           CornerRadius="4"
                                           Padding="12">
                                        <Label Text="{Binding Request.Notes}"
                                               FontSize="13"
                                               TextColor="{AppThemeBinding Light=#333333, Dark=#CCCCCC}" />
                                    </Frame>
                                </VerticalStackLayout>
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Request not available message -->
                    <Frame IsVisible="{Binding Request, Converter={StaticResource ObjectToInverseBoolConverter}}"
                           BackgroundColor="{AppThemeBinding Light=#FFF3E0, Dark=#3E2723}"
                           BorderColor="{AppThemeBinding Light=#FFB74D, Dark=#FF8F00}"
                           CornerRadius="8"
                           Padding="16">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Request Not Available"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#E65100, Dark=#FFB74D}" />
                            <Label Text="The request.json file is missing or could not be parsed. This run may have been created by an older version."
                                   FontSize="13"
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                            <Button Text="Open Run Folder"
                                    Command="{Binding OpenRunFolderCommand}"
                                    BackgroundColor="{AppThemeBinding Light=#FF8F00, Dark=#E65100}"
                                    TextColor="White"
                                    CornerRadius="4"
                                    Padding="12,6"
                                    HorizontalOptions="Start"
                                    FontSize="12" />
                        </VerticalStackLayout>
                    </Frame>

                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <!-- RESULT SECTION -->
                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                           BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                           CornerRadius="8"
                           Padding="16"
                           IsVisible="{Binding Result, Converter={StaticResource ObjectToBoolConverter}}">
                        <VerticalStackLayout Spacing="12">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Grid.Column="0"
                                       Text="Training Result"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}" />
                                <Button Grid.Column="1"
                                        Text="Open JSON"
                                        Command="{Binding OpenRawFileCommand}"
                                        CommandParameter="result.json"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                                        FontSize="12"
                                        Padding="8,4" />
                            </Grid>

                            <Grid ColumnDefinitions="140,*" RowDefinitions="Auto,Auto,Auto" RowSpacing="8">
                                <Label Grid.Row="0" Grid.Column="0" Text="Status:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Grid.Row="0" Grid.Column="1"
                                       Text="{Binding Result.Status}"
                                       FontAttributes="Bold"
                                       TextColor="{Binding Result.IsSucceeded, Converter={StaticResource SuccessToColorConverter}}" />

                                <Label Grid.Row="1" Grid.Column="0" Text="Duration:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Grid.Row="1" Grid.Column="1" Text="{Binding Result.Duration, StringFormat='{0:mm\\:ss\\.fff}'}" />

                                <Label Grid.Row="2" Grid.Column="0" Text="Error:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}"
                                       IsVisible="{Binding Result.Error, Converter={StaticResource ObjectToBoolConverter}}" />
                                <Label Grid.Row="2" Grid.Column="1" Text="{Binding Result.Error.Message}"
                                       TextColor="{AppThemeBinding Light=#C62828, Dark=#EF5350}"
                                       IsVisible="{Binding Result.Error, Converter={StaticResource ObjectToBoolConverter}}" />
                            </Grid>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <!-- METRICS SECTION -->
                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                           BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                           CornerRadius="8"
                           Padding="16"
                           IsVisible="{Binding Metrics, Converter={StaticResource ObjectToBoolConverter}}">
                        <VerticalStackLayout Spacing="12">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Grid.Column="0"
                                       Text="Training Metrics"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}" />
                                <Button Grid.Column="1"
                                        Text="Open JSON"
                                        Command="{Binding OpenRawFileCommand}"
                                        CommandParameter="metrics.json"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                                        FontSize="12"
                                        Padding="8,4" />
                            </Grid>

                            <Grid ColumnDefinitions="140,*" RowDefinitions="Auto,Auto,Auto" RowSpacing="8">
                                <Label Grid.Row="0" Grid.Column="0" Text="Accuracy:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Grid.Row="0" Grid.Column="1"
                                       Text="{Binding Metrics.AccuracyPercent}"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#2E7D32, Dark=#81C784}" />

                                <Label Grid.Row="1" Grid.Column="0" Text="Samples:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Grid.Row="1" Grid.Column="1" Text="{Binding Metrics.NumSamples, StringFormat='{0:N0}'}" />

                                <Label Grid.Row="2" Grid.Column="0" Text="Features:" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Grid.Row="2" Grid.Column="1" Text="{Binding Metrics.NumFeatures, StringFormat='{0:N0}'}" />
                            </Grid>
                        </VerticalStackLayout>
                    </Frame>

                </VerticalStackLayout>
            </Grid>
        </ScrollView>

        <!-- Status message toast -->
        <Frame Grid.Row="2"
               IsVisible="{Binding StatusMessage, Converter={StaticResource StringToBoolConverter}}"
               BackgroundColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
               CornerRadius="4"
               Padding="12,8"
               Margin="0,8,0,0"
               HorizontalOptions="Center">
            <Label Text="{Binding StatusMessage}"
                   TextColor="White"
                   FontSize="13" />
        </Frame>

        <!-- Raw JSON Modal Overlay -->
        <Grid Grid.RowSpan="3"
              IsVisible="{Binding ShowRawJsonModal}"
              BackgroundColor="#80000000">
            <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                   BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                   CornerRadius="8"
                   Padding="0"
                   Margin="32"
                   MaximumWidthRequest="800"
                   MaximumHeightRequest="600"
                   HorizontalOptions="Center"
                   VerticalOptions="Center">
                <Grid RowDefinitions="Auto,*,Auto">
                    <!-- Modal header -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Padding="16" BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#1A1A1A}">
                        <Label Grid.Column="0"
                               Text="{Binding RawJsonTitle}"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}"
                               VerticalOptions="Center" />
                        <Button Grid.Column="1"
                                Text="✕"
                                Command="{Binding CloseRawJsonModalCommand}"
                                BackgroundColor="Transparent"
                                TextColor="{AppThemeBinding Light=#666666, Dark=#999999}"
                                FontSize="18"
                                Padding="8,4"
                                WidthRequest="40" />
                    </Grid>

                    <!-- JSON content -->
                    <ScrollView Grid.Row="1" Padding="16">
                        <Label Text="{Binding RawJsonContent}"
                               FontFamily="Consolas, Courier New, monospace"
                               FontSize="12"
                               TextColor="{AppThemeBinding Light=#333333, Dark=#CCCCCC}"
                               LineBreakMode="NoWrap" />
                    </ScrollView>

                    <!-- Modal footer -->
                    <HorizontalStackLayout Grid.Row="2"
                                           Padding="16"
                                           Spacing="8"
                                           HorizontalOptions="End"
                                           BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#1A1A1A}">
                        <Button Text="Copy"
                                Command="{Binding CopyRawJsonCommand}"
                                BackgroundColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                                TextColor="White"
                                CornerRadius="4"
                                Padding="16,8" />
                        <Button Text="Close"
                                Command="{Binding CloseRawJsonModalCommand}"
                                BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                                TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}"
                                CornerRadius="4"
                                Padding="16,8" />
                    </HorizontalStackLayout>
                </Grid>
            </Frame>
        </Grid>

        <!-- Diff from Parent Modal Overlay -->
        <Grid Grid.RowSpan="3"
              IsVisible="{Binding ShowDiffModal}"
              BackgroundColor="#80000000">
            <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                   BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                   CornerRadius="8"
                   Padding="0"
                   Margin="32"
                   MaximumWidthRequest="900"
                   MaximumHeightRequest="700"
                   HorizontalOptions="Center"
                   VerticalOptions="Center">
                <Grid RowDefinitions="Auto,Auto,*">
                    <!-- Modal header -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Padding="16" BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#1A1A1A}">
                        <VerticalStackLayout Grid.Column="0">
                            <Label Text="Changes from Parent"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}" />
                            <Label Text="{Binding DiffResult.ParentRunId, StringFormat='Parent: {0}'}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                        </VerticalStackLayout>
                        <Button Grid.Column="1"
                                Text="✕"
                                Command="{Binding CloseDiffModalCommand}"
                                BackgroundColor="Transparent"
                                TextColor="{AppThemeBinding Light=#666666, Dark=#999999}"
                                FontSize="18"
                                Padding="8,4"
                                WidthRequest="40"
                                VerticalOptions="Start" />
                    </Grid>

                    <!-- Key field differences table -->
                    <Frame Grid.Row="1"
                           BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#1A1A1A}"
                           BorderColor="Transparent"
                           CornerRadius="0"
                           Padding="16"
                           IsVisible="{Binding DiffResult.HasDifferences}">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Changed Fields"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}" />

                            <!-- Diff table header -->
                            <Grid ColumnDefinitions="120,*,*" ColumnSpacing="8">
                                <Label Grid.Column="0" Text="Field" FontAttributes="Bold" FontSize="12" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Grid.Column="1" Text="Parent Value" FontAttributes="Bold" FontSize="12" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                <Label Grid.Column="2" Text="Current Value" FontAttributes="Bold" FontSize="12" TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                            </Grid>

                            <BoxView HeightRequest="1" Color="{AppThemeBinding Light=#E0E0E0, Dark=#404040}" />

                            <!-- Diff rows -->
                            <VerticalStackLayout BindableLayout.ItemsSource="{Binding DiffResult.Differences}" Spacing="6">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:DiffItem">
                                        <Grid ColumnDefinitions="120,*,*" ColumnSpacing="8">
                                            <Label Grid.Column="0"
                                                   Text="{Binding DisplayName}"
                                                   FontSize="12"
                                                   FontAttributes="Bold"
                                                   TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}" />
                                            <Frame Grid.Column="1"
                                                   BackgroundColor="{AppThemeBinding Light=#FFEBEE, Dark=#3E2723}"
                                                   BorderColor="Transparent"
                                                   CornerRadius="4"
                                                   Padding="6,4"
                                                   HasShadow="False">
                                                <Label Text="{Binding ParentValue}"
                                                       FontSize="11"
                                                       FontFamily="Consolas, Courier New, monospace"
                                                       TextColor="{AppThemeBinding Light=#C62828, Dark=#EF9A9A}"
                                                       LineBreakMode="TailTruncation" />
                                            </Frame>
                                            <Frame Grid.Column="2"
                                                   BackgroundColor="{AppThemeBinding Light=#E8F5E9, Dark=#1B3D20}"
                                                   BorderColor="Transparent"
                                                   CornerRadius="4"
                                                   Padding="6,4"
                                                   HasShadow="False">
                                                <Label Text="{Binding CurrentValue}"
                                                       FontSize="11"
                                                       FontFamily="Consolas, Courier New, monospace"
                                                       TextColor="{AppThemeBinding Light=#2E7D32, Dark=#A5D6A7}"
                                                       LineBreakMode="TailTruncation" />
                                            </Frame>
                                        </Grid>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- No differences message -->
                    <Frame Grid.Row="1"
                           BackgroundColor="{AppThemeBinding Light=#E8F5E9, Dark=#1B3D20}"
                           BorderColor="Transparent"
                           CornerRadius="0"
                           Padding="16"
                           IsVisible="{Binding DiffResult.HasDifferences, Converter={StaticResource InverseBoolConverter}}">
                        <Label Text="No differences found - this run has the same configuration as its parent."
                               FontSize="13"
                               TextColor="{AppThemeBinding Light=#2E7D32, Dark=#A5D6A7}"
                               HorizontalOptions="Center" />
                    </Frame>

                    <!-- Side-by-side JSON (scrollable) -->
                    <Grid Grid.Row="2" ColumnDefinitions="*,*" ColumnSpacing="0" Padding="16">
                        <!-- Parent JSON -->
                        <Frame Grid.Column="0"
                               BackgroundColor="{AppThemeBinding Light=#1E1E1E, Dark=#0D0D0D}"
                               BorderColor="{AppThemeBinding Light=#333333, Dark=#1A1A1A}"
                               CornerRadius="4"
                               Padding="0"
                               Margin="0,0,8,0">
                            <Grid RowDefinitions="Auto,*">
                                <Label Grid.Row="0"
                                       Text="Parent (original)"
                                       FontSize="11"
                                       FontAttributes="Bold"
                                       BackgroundColor="{AppThemeBinding Light=#2D2D2D, Dark=#1A1A1A}"
                                       TextColor="{AppThemeBinding Light=#CCCCCC, Dark=#999999}"
                                       Padding="8,6" />
                                <ScrollView Grid.Row="1">
                                    <Label Text="{Binding ParentJsonContent}"
                                           FontFamily="Consolas, Courier New, monospace"
                                           FontSize="11"
                                           TextColor="{AppThemeBinding Light=#CCCCCC, Dark=#AAAAAA}"
                                           LineBreakMode="NoWrap"
                                           Padding="8" />
                                </ScrollView>
                            </Grid>
                        </Frame>

                        <!-- Current JSON -->
                        <Frame Grid.Column="1"
                               BackgroundColor="{AppThemeBinding Light=#1E1E1E, Dark=#0D0D0D}"
                               BorderColor="{AppThemeBinding Light=#333333, Dark=#1A1A1A}"
                               CornerRadius="4"
                               Padding="0"
                               Margin="8,0,0,0">
                            <Grid RowDefinitions="Auto,*">
                                <Label Grid.Row="0"
                                       Text="Current (this run)"
                                       FontSize="11"
                                       FontAttributes="Bold"
                                       BackgroundColor="{AppThemeBinding Light=#2D2D2D, Dark=#1A1A1A}"
                                       TextColor="{AppThemeBinding Light=#CCCCCC, Dark=#999999}"
                                       Padding="8,6" />
                                <ScrollView Grid.Row="1">
                                    <Label Text="{Binding CurrentJsonContent}"
                                           FontFamily="Consolas, Courier New, monospace"
                                           FontSize="11"
                                           TextColor="{AppThemeBinding Light=#CCCCCC, Dark=#AAAAAA}"
                                           LineBreakMode="NoWrap"
                                           Padding="8" />
                                </ScrollView>
                            </Grid>
                        </Frame>
                    </Grid>
                </Grid>
            </Frame>
        </Grid>

    </Grid>

</ContentPage>
