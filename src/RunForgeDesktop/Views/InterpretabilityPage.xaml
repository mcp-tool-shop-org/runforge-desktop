<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:RunForgeDesktop.ViewModels"
             xmlns:models="clr-namespace:RunForgeDesktop.Core.Models;assembly=RunForgeDesktop.Core"
             x:Class="RunForgeDesktop.Views.InterpretabilityPage"
             x:DataType="vm:InterpretabilityViewModel"
             Title="Interpretability">

    <Grid RowDefinitions="Auto,*" Padding="16">

        <!-- Header -->
        <VerticalStackLayout Grid.Row="0" Spacing="4" Margin="0,0,0,16">
            <Label Text="Interpretability Index"
                   FontSize="24"
                   FontAttributes="Bold"
                   TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#E0E0E0}" />
            <Label Text="{Binding RunName}"
                   FontSize="14"
                   TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
            <Label Text="{Binding Index.ModelFamily, StringFormat='Model: {0}'}"
                   FontSize="12"
                   TextColor="{AppThemeBinding Light=#888888, Dark=#777777}"
                   IsVisible="{Binding Index, Converter={StaticResource ObjectToBoolConverter}}" />
        </VerticalStackLayout>

        <!-- Content -->
        <ScrollView Grid.Row="1">
            <Grid>
                <!-- Loading indicator -->
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                   IsVisible="{Binding IsLoading}"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"
                                   Color="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}" />

                <!-- Not found message -->
                <Frame IsVisible="{Binding NotFound}"
                       BackgroundColor="{AppThemeBinding Light=#FFF3E0, Dark=#3E2723}"
                       BorderColor="{AppThemeBinding Light=#FFB74D, Dark=#FF8F00}"
                       CornerRadius="8"
                       Padding="24"
                       Margin="0,32"
                       MaximumWidthRequest="450">
                    <VerticalStackLayout Spacing="16" HorizontalOptions="Center">
                        <Label Text="Interpretability Index Not Found"
                               FontSize="18"
                               FontAttributes="Bold"
                               HorizontalTextAlignment="Center"
                               TextColor="{AppThemeBinding Light=#E65100, Dark=#FFB74D}" />

                        <Label Text="This run does not have an interpretability index file."
                               FontSize="14"
                               HorizontalTextAlignment="Center"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />

                        <VerticalStackLayout Spacing="8" Margin="0,8,0,0">
                            <Label Text="Possible reasons:"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#555555, Dark=#AAAAAA}" />

                            <VerticalStackLayout Spacing="6" Margin="8,0,0,0">
                                <HorizontalStackLayout Spacing="6">
                                    <Label Text="•" TextColor="{AppThemeBinding Light=#888888, Dark=#777777}" />
                                    <Label Text="Run predates interpretability feature"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Spacing="6">
                                    <Label Text="•" TextColor="{AppThemeBinding Light=#888888, Dark=#777777}" />
                                    <Label Text="Model type does not support interpretability"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Spacing="6">
                                    <Label Text="•" TextColor="{AppThemeBinding Light=#888888, Dark=#777777}" />
                                    <Label Text="Training was interrupted before completion"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                        </VerticalStackLayout>

                        <Label Text="Interpretability artifacts are generated during training by RunForge CLI or VS Code extension."
                               FontSize="11"
                               HorizontalTextAlignment="Center"
                               TextColor="{AppThemeBinding Light=#888888, Dark=#777777}" />
                    </VerticalStackLayout>
                </Frame>

                <!-- Error message -->
                <Frame IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}"
                       BackgroundColor="{AppThemeBinding Light=#FFEBEE, Dark=#3E2723}"
                       BorderColor="{AppThemeBinding Light=#EF5350, Dark=#D32F2F}"
                       CornerRadius="8"
                       Padding="16"
                       Margin="0,0,0,16">
                    <VerticalStackLayout Spacing="8">
                        <Label Text="Error loading interpretability index"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#C62828, Dark=#EF5350}" />
                        <Label Text="{Binding ErrorMessage}"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                    </VerticalStackLayout>
                </Frame>

                <!-- Interpretability content -->
                <VerticalStackLayout Spacing="16"
                                     IsVisible="{Binding Index, Converter={StaticResource ObjectToBoolConverter}}">

                    <!-- Artifacts list -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                           BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                           CornerRadius="8"
                           Padding="16">
                        <VerticalStackLayout Spacing="12">
                            <Label Text="Artifact Index"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}" />

                            <CollectionView ItemsSource="{Binding Index.Artifacts}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:ArtifactEntry">
                                        <Frame Margin="0,4" Padding="12" CornerRadius="4"
                                               BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#333333}"
                                               BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}">
                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                                <!-- Status indicator -->
                                                <BoxView Grid.Column="0"
                                                         WidthRequest="8"
                                                         HeightRequest="8"
                                                         CornerRadius="4"
                                                         VerticalOptions="Center"
                                                         Color="{Binding Status, Converter={StaticResource ArtifactStatusToColorConverter}}" />

                                                <!-- Artifact info -->
                                                <VerticalStackLayout Grid.Column="1" Spacing="2">
                                                    <HorizontalStackLayout Spacing="8">
                                                        <Label Text="{Binding Type}"
                                                               FontSize="14"
                                                               FontAttributes="Bold"
                                                               TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}" />
                                                        <!-- Status label -->
                                                        <Frame Padding="6,2"
                                                               CornerRadius="4"
                                                               BackgroundColor="{Binding Status, Converter={StaticResource ArtifactStatusToColorConverter}}"
                                                               HasShadow="False">
                                                            <Label Text="{Binding StatusLabel}"
                                                                   FontSize="10"
                                                                   TextColor="White" />
                                                        </Frame>
                                                    </HorizontalStackLayout>
                                                    <Label Text="{Binding Path}"
                                                           FontSize="12"
                                                           TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                                                    <!-- Show reason when unavailable -->
                                                    <Label Text="{Binding StatusReason}"
                                                           FontSize="11"
                                                           TextColor="{Binding Status, Converter={StaticResource ArtifactStatusToTextColorConverter}}"
                                                           IsVisible="{Binding StatusReason, Converter={StaticResource StringToBoolConverter}}" />
                                                </VerticalStackLayout>

                                                <!-- Schema version -->
                                                <Label Grid.Column="2"
                                                       Text="{Binding SchemaVersion, StringFormat='v{0}'}"
                                                       FontSize="12"
                                                       TextColor="{AppThemeBinding Light=#888888, Dark=#777777}"
                                                       VerticalOptions="Center" />
                                            </Grid>
                                        </Frame>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Metrics preview (if available) -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                           BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                           CornerRadius="8"
                           Padding="16"
                           IsVisible="{Binding MetricsArtifact, Converter={StaticResource ObjectToBoolConverter}}">
                        <VerticalStackLayout Spacing="12">
                            <Grid ColumnDefinitions="*,Auto,Auto">
                                <Label Grid.Column="0"
                                       Text="Metrics (v1)"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}" />
                                <Button Grid.Column="1"
                                        Text="View Details"
                                        Command="{Binding NavigateToMetricsDetailCommand}"
                                        BackgroundColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                                        TextColor="White"
                                        FontSize="12"
                                        CornerRadius="4"
                                        Padding="12,4"
                                        Margin="0,0,8,0" />
                                <Button Grid.Column="2"
                                        Text="Open JSON"
                                        Command="{Binding OpenArtifactCommand}"
                                        CommandParameter="metrics.v1"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                                        FontSize="12"
                                        Padding="8,4" />
                            </Grid>
                            <Label Text="{Binding MetricsArtifact.ProfileId, StringFormat='Profile: {0}'}"
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Feature importance preview (if available) -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                           BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                           CornerRadius="8"
                           Padding="16"
                           IsVisible="{Binding FeatureImportance, Converter={StaticResource ObjectToBoolConverter}}">
                        <VerticalStackLayout Spacing="12">
                            <Grid ColumnDefinitions="*,Auto,Auto">
                                <Label Grid.Column="0"
                                       Text="Feature Importance (v1)"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}" />
                                <Button Grid.Column="1"
                                        Text="View Details"
                                        Command="{Binding NavigateToFeatureImportanceCommand}"
                                        BackgroundColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                                        TextColor="White"
                                        FontSize="12"
                                        CornerRadius="4"
                                        Padding="12,4"
                                        Margin="0,0,8,0" />
                                <Button Grid.Column="2"
                                        Text="Open JSON"
                                        Command="{Binding OpenArtifactCommand}"
                                        CommandParameter="feature_importance.v1"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                                        FontSize="12"
                                        Padding="8,4" />
                            </Grid>
                            <Label Text="{Binding FeatureImportance.Method, StringFormat='Method: {0}'}"
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                            <Label Text="{Binding FeatureImportance.Importances.Count, StringFormat='{0} features ranked'}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light=#888888, Dark=#777777}" />
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Linear coefficients preview (if available) -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                           BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                           CornerRadius="8"
                           Padding="16"
                           IsVisible="{Binding LinearCoefficients, Converter={StaticResource ObjectToBoolConverter}}">
                        <VerticalStackLayout Spacing="12">
                            <Grid ColumnDefinitions="*,Auto,Auto">
                                <Label Grid.Column="0"
                                       Text="Linear Coefficients (v1)"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#333333, Dark=#EEEEEE}" />
                                <Button Grid.Column="1"
                                        Text="View Details"
                                        Command="{Binding NavigateToLinearCoefficientsCommand}"
                                        BackgroundColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                                        TextColor="White"
                                        FontSize="12"
                                        CornerRadius="4"
                                        Padding="12,4"
                                        Margin="0,0,8,0" />
                                <Button Grid.Column="2"
                                        Text="Open JSON"
                                        Command="{Binding OpenArtifactCommand}"
                                        CommandParameter="linear_coefficients.v1"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light=#1E3A5F, Dark=#4A7BA7}"
                                        FontSize="12"
                                        Padding="8,4" />
                            </Grid>
                            <Label Text="{Binding LinearCoefficients.ClassLabels.Count, StringFormat='{0} class(es)'}"
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#999999}" />
                            <Frame BackgroundColor="{AppThemeBinding Light=#FFF8E1, Dark=#3E2723}"
                                   BorderColor="{AppThemeBinding Light=#FFE082, Dark=#FF8F00}"
                                   CornerRadius="4"
                                   Padding="8">
                                <Label Text="Note: Coefficients are in standardized space"
                                       FontSize="11"
                                       TextColor="{AppThemeBinding Light=#F57C00, Dark=#FFB74D}" />
                            </Frame>
                        </VerticalStackLayout>
                    </Frame>

                </VerticalStackLayout>
            </Grid>
        </ScrollView>

    </Grid>

</ContentPage>
